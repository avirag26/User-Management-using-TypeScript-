<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Home</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <nav>
      <ul
        class="nav nav-pills nav-fill gap-2 p-1 small bg-primary rounded-5 shadow-sm"
        id="pillNav2"
        role="tablist"
        style="
          --bs-nav-link-color: var(--bs-white);
          --bs-nav-pills-link-active-color: var(--bs-primary);
          --bs-nav-pills-link-active-bg: var(--bs-white);
        "
      >
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active rounded-5"
            id="home-tab2"
            data-bs-toggle="tab"
            type="button"
            role="tab"
            aria-selected="true"
          >
            Home
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            data-bs-toggle="modal"
            data-bs-target="#editUserModal"
            class="nav-link rounded-5"
            id="edit-tab2"
            data-bs-toggle="tab"
            type="submit"
            role="tab"
            data-id="<%= userDetails._id %>"
            aria-selected="false"
          >
            Edit
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <form action="/user/logout">
            <button
              class="nav-link rounded-5"
              id="contact-tab2"
              data-bs-toggle="tab"
              type="submit"
              role="tab"
              aria-selected="false"
            >
              Logout
            </button>
          </form>
        </li>
      </ul>
    </nav>

    <!-- .................... -->
    <h1 class="text-center text-white">
      Welcome Home <%= userDetails.username %>
    </h1>

    <!-- Edit User Modal -->
    <div
      class="modal fade"
      id="editUserModal"
      tabindex="-1"
      aria-labelledby="editUserModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content bg-secondary text-light">
          <div class="modal-header">
            <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="editUserForm" action="/admin/edit-user" method="POST">
              <input type="hidden" id="editUserId" name="id" />
              <div class="mb-3">
                <label for="editUserName" class="form-label">Name</label>
                <input
                  type="text"
                  id="editUserName"
                  name="userName"
                  class="form-control"
                  required
                />
                <div class="invalid-feedback">
                  Please enter a valid name (min 4 characters).
                </div>
              </div>

              <div class="mb-3">
                <label for="editUserEmail" class="form-label">Email</label>
                <input
                  type="email"
                  id="editUserEmail"
                  name="email"
                  class="form-control"
                  required
                />
                <div class="invalid-feedback">Please enter a valid email.</div>
              </div>

              <div class="modal-footer">
                <button
                  type="submit"
                  form="editUserForm"
                  class="btn btn-primary"
                >
                  Update
                </button>
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal"
                >
                  Close
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- /////////////// -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
      <div
        id="successToast"
        class="toast align-items-center text-white bg-success border-0"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
      >
        <div class="d-flex">
          <div id="toast-message" class="toast-body">
            User updated successfully!
          </div>
          <button
            type="button"
            class="btn-close btn-close-white me-2 m-auto"
            data-bs-dismiss="toast"
            aria-label="Close"
          ></button>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const editBtn = document.getElementById('edit-tab2');
      editBtn.addEventListener('click', async function (e) {
        const id = e.target.dataset.id;
        if (!id) return hideModal();
        console.log(id);

        try {
          const response = await fetch(`/user/get-user/${id}`);
          const data = await response.json();
          if (!data.success) return;
          const user = data?.user;
          populateEditUserModal(user._id, user.username, user.email);
        } catch (error) {}
      });
      function populateEditUserModal(id, fullName, email) {
        document.getElementById('editUserId').value = id;
        document.getElementById('editUserName').value = fullName;
        document.getElementById('editUserEmail').value = email;
      }

      document
        .getElementById('editUserForm')
        .addEventListener('submit', async function (event) {
          event.preventDefault();

          const nameInput = document.getElementById('editUserName');
          const emailInput = document.getElementById('editUserEmail');
          const userId = document.getElementById('editUserId').value;

          const name = nameInput.value.trim();
          const email = emailInput.value.trim();
          const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

          let hasError = false;

          // Clear previous validation styles
          nameInput.classList.remove('is-invalid');
          emailInput.classList.remove('is-invalid');

          if (!name || name.length < 4) {
            nameInput.classList.add('is-invalid');
            hasError = true;
          }

          if (!email || !emailPattern.test(email)) {
            emailInput.classList.add('is-invalid');
            hasError = true;
          }
          if (hasError) return;
          try {
            console.log('hai');
            const response = await fetch(`/user/update-user/${userId}`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ username: name, email }),
            });
            const data = await response.json();
            console.log(data);

            if (response.ok) {
              hideModal();
              const toastElement = document.getElementById('successToast');
              const toast = new bootstrap.Toast(toastElement, { delay: 2000 });
              toast.show();
            }
          } catch (error) {}
        });

      function hideModal() {
        const modalElement = document.getElementById('editUserModal');
        const modalInstance = bootstrap.Modal.getInstance(modalElement);
        modalInstance.hide();
      }
    </script>
  </body>
</html>
